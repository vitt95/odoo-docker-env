version: '3.7' # Puoi rimuovere questa riga se ti d√† fastidio, ma la lascio per chiarezza

services:
  # Servizio Database PostgreSQL
  db:
    image: postgres:16-alpine 
    restart: unless-stopped
    environment:
      - POSTGRES_DB=odoo_db
      - POSTGRES_USER=odoo_user
      - POSTGRES_PASSWORD=odoo_password # ‚ö†Ô∏è Cambia questa password!
    volumes:
      - odoo17-database-data:/var/lib/postgresql/data

  # Servizio Web Odoo (Ora costruito da zero)
  odoo:
    build:
      context: . 
      dockerfile: Dockerfile 
    restart: unless-stopped
    depends_on:
      - db
    ports:
      - "8069:8069" # Odoo Web: http://localhost:8069
      - "8072:8072" # Long Polling
    environment:
      - DB_HOST=db # Variabile usata da entrypoint.sh (nome del servizio)
      - DB_USER=odoo_user # Variabile usata da entrypoint.sh
      - DB_PASSWORD=odoo_password # Variabile usata da entrypoint.sh
      - ODOO_MASTER_PASSWD=odoo # ‚ö†Ô∏è Password Master di Odoo (IMPORTANTE: Cambiala!)
    volumes:
      # Mappiamo i dati web (sessioni, allegati)
      - odoo17-web-data:/var/lib/odoo
      # Mappiamo in lettura/scrittura il codice sorgente (per la modifica)
      - ./src:/opt/odoo/src 
      # Mappiamo in lettura/scrittura i moduli custom
      - ./custom_addons:/mnt/extra-addons
      # Mappiamo in lettura il file di configurazione
      - ./config/odoo.conf:/etc/odoo/odoo.conf
    # üí• RIMOZIONE DI "command": Questo assicura che venga eseguito l'ENTRYPOINT e il CMD del Dockerfile.
    # command: python3 /opt/odoo/src/odoo-bin -c /etc/odoo/odoo.conf

  # Servizio Database Explorer (pgAdmin 4)
  pgadmin:
    image: dpage/pgadmin4
    restart: unless-stopped
    depends_on:
      - db
    ports:
      - "5050:80" # pgAdmin Web: http://localhost:5050
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@odoo.com # (Risolto l'errore .local)
      - PGADMIN_DEFAULT_PASSWORD=admin_password 
      - PGADMIN_CONFIG_SERVER_MODE=False
    volumes:
      - pgadmin-data:/var/lib/pgadmin
      
# Definizione dei volumi per la persistenza dei dati
volumes:
  odoo17-web-data:
  odoo17-database-data:
  pgadmin-data:
